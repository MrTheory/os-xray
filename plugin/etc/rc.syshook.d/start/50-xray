#!/bin/sh

LOG="/tmp/xray_syshook.log"
LOG_MAX=50000   # ~50 KB — максимальный размер лога перед ротацией (B11)

# B11: ротация лога — без неё при каждом ребуте старый лог перезаписывается.
# Храним последние 2 версии: xray_syshook.log и xray_syshook.log.0
# tail -c усекает содержимое до LOG_MAX байт чтобы лог не рос бесконечно.
if [ -f "$LOG" ]; then
    _size=$(wc -c < "$LOG" 2>/dev/null || echo 0)
    if [ "$_size" -gt "$LOG_MAX" ]; then
        mv -f "$LOG" "${LOG}.0"
    fi
fi

# Дописываем в лог (>>) — не перезаписываем, сохраняем историю предыдущих запусков
exec >> "$LOG" 2>&1
echo ""
echo "=== xray syshook start: $(date) ==="

XRAY_BIN="/usr/local/bin/xray-core"
XRAY_CONF="/usr/local/etc/xray-core/config.json"
XRAY_PID="/var/run/xray_core.pid"
T2S_BIN="/usr/local/tun2socks/tun2socks"
T2S_CONF="/usr/local/tun2socks/config.yaml"
T2S_PID="/var/run/tun2socks.pid"

ENABLED=$(php -r 'require_once("config.inc"); $cfg = OPNsense\Core\Config::getInstance()->object(); echo (string)($cfg->OPNsense->xray->general->enabled ?? "0");' 2>/dev/null)

TUN_IFACE=$(php -r 'require_once("config.inc"); $cfg = OPNsense\Core\Config::getInstance()->object(); echo (string)($cfg->OPNsense->xray->instance->tun_interface ?? "proxytun2socks0");' 2>/dev/null)

MTU=$(php -r 'require_once("config.inc"); $cfg = OPNsense\Core\Config::getInstance()->object(); echo (string)($cfg->OPNsense->xray->instance->mtu ?? "1500");' 2>/dev/null)

TUN_IFACE="${TUN_IFACE:-proxytun2socks0}"
MTU="${MTU:-1500}"

echo "enabled=[$ENABLED] tun=[$TUN_IFACE] mtu=[$MTU]"

[ "$ENABLED" = "1" ] || { echo "xray disabled, exit"; exit 0; }
[ -f "$XRAY_BIN" ]   || { echo "xray-core not found"; exit 0; }
[ -f "$T2S_BIN" ]    || { echo "tun2socks not found"; exit 0; }

# BUG-8 FIX: race condition — xray.inc (boot hook, priority 10) может запускать сервисы
# параллельно с 50-xray (syshook). Ждём lock-файл до 10 секунд.
XRAY_LOCK="/var/run/xray_start.lock"
_lock_tries=0
while [ -f "$XRAY_LOCK" ] && [ $_lock_tries -lt 10 ]; do
    echo "  waiting for xray lock (${_lock_tries}s)..."
    sleep 1
    _lock_tries=$((_lock_tries+1))
done
if [ -f "$XRAY_LOCK" ]; then
    echo "WARNING: xray lock still held after 10s, proceeding anyway"
fi

# BUG-2 FIX: TUN_IFACE передаётся через переменную окружения, не через interpolation в PHP-строку.
# До исправления: $tun = "'"$TUN_IFACE"'" — злоумышленник мог задать tun_interface='; system("rm -rf /"); #
# После: _TUN_IFACE=$TUN_IFACE — PHP читает через getenv(), shell-код невозможен.
_TUN_IFACE="$TUN_IFACE" TUN_IP=$(php -r 'require_once("config.inc"); $cfg = OPNsense\Core\Config::getInstance()->object(); $tun = getenv("_TUN_IFACE"); if (empty($tun)) $tun = "proxytun2socks0"; foreach ($cfg->interfaces->children() as $iface) { if ((string)$iface->if === $tun) { echo (string)$iface->ipaddr . "/" . (string)$iface->subnet; break; } }' 2>/dev/null)

echo "TUN IP: [$TUN_IP]"

# Запускаем xray если не запущен
XRAY_RUNNING=0
if [ -f "$XRAY_PID" ]; then
    /bin/kill -0 "$(cat $XRAY_PID)" 2>/dev/null && XRAY_RUNNING=1
fi
echo "xray running: $XRAY_RUNNING"
if [ "$XRAY_RUNNING" -eq 0 ]; then
    echo "starting xray-core..."
    /usr/sbin/daemon -p "$XRAY_PID" "$XRAY_BIN" run -c "$XRAY_CONF"
    sleep 1
fi

# Запускаем tun2socks если не запущен
T2S_RUNNING=0
if [ -f "$T2S_PID" ]; then
    /bin/kill -0 "$(cat $T2S_PID)" 2>/dev/null && T2S_RUNNING=1
fi
echo "tun2socks running: $T2S_RUNNING"
if [ "$T2S_RUNNING" -eq 0 ]; then
    echo "starting tun2socks..."
    /usr/sbin/daemon -p "$T2S_PID" "$T2S_BIN" -config "$T2S_CONF"
fi

# Ждём TUN интерфейс до 10 секунд
echo "waiting for $TUN_IFACE..."
i=0
while [ $i -lt 10 ]; do
    ifconfig "$TUN_IFACE" > /dev/null 2>&1 && break
    sleep 1
    i=$((i+1))
    echo "  ${i}s..."
done

ifconfig "$TUN_IFACE" > /dev/null 2>&1 || { echo "interface not found after 10s!"; exit 0; }

echo "ifconfig before setup:"
ifconfig "$TUN_IFACE" 2>&1

# Поднимаем интерфейс
echo "bringing up $TUN_IFACE..."
ifconfig "$TUN_IFACE" mtu "$MTU" up 2>&1

# Назначаем IP
if [ -n "$TUN_IP" ]; then
    echo "assigning $TUN_IP..."
    ifconfig "$TUN_IFACE" inet "$TUN_IP" 2>&1
else
    echo "WARNING: no IP found in config, skipping IP assignment"
fi

echo "ifconfig after setup:"
ifconfig "$TUN_IFACE" 2>&1

echo "reloading filter..."
/usr/local/sbin/configctl filter reload 2>&1

echo "reconfiguring interface..."
/usr/local/sbin/configctl interface reconfigure "$TUN_IFACE" 2>&1

echo "=== done: $(date) ==="
exit 0
